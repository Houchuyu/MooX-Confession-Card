<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨ã—ã‚­ãƒ£ãƒ©å‘Šç™½ã‚«ãƒ¼ãƒ‰ - Character Confession Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@300;400;500&family=M+PLUS+Rounded+1c:wght@300;400;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'M PLUS Rounded 1c', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }
        .card-bg {
            background-color: #ffffff;
            background-image: 
                radial-gradient(at 0% 0%, rgba(254, 226, 226, 0.5) 0, rgba(255, 255, 255, 0) 50%), 
                radial-gradient(at 100% 0%, rgba(255, 209, 220, 0.5) 0, rgba(255, 255, 255, 0) 50%),
                radial-gradient(at 100% 100%, rgba(253, 224, 245, 0.5) 0, rgba(255, 255, 255, 0) 50%),
                radial-gradient(at 0% 100%, rgba(255, 241, 242, 0.5) 0, rgba(255, 255, 255, 0) 50%);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }
        .polaroid {
            background: white;
            padding: 0.75rem;
            padding-bottom: 2.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: rotate(-1.5deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #f1f5f9;
        }
        .polaroid:hover {
            transform: rotate(0deg) scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .tape {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%) rotate(2deg);
            width: 100px;
            height: 30px;
            background: rgba(216, 180, 254, 0.4);
            backdrop-filter: blur(2px);
            z-index: 20;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #f3f4f6;
            color: #6b7280;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
            line-height: normal; /* Use normal line height */
        }
        .handwriting {
            font-family: 'Kiwi Maru', serif;
        }
    </style>
</head>
<body class="min-h-screen py-12 px-4 flex flex-col items-center gap-8">

    <!-- Preview Title -->
    <div class="w-full max-w-5xl text-left -mb-4 pl-2">
        <h2 class="text-slate-500 font-bold text-lg tracking-wider">ã€å‘Šç™½è¨˜å¿µã‚«ãƒ¼ãƒ‰ã€‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
    </div>

    <!-- Card Container -->
    <div id="confession-card" class="card-bg w-full max-w-5xl min-h-[720px] rounded-3xl flex flex-col md:flex-row p-10 gap-8 border border-white">
        <!-- Decoration Elements -->
        <div class="absolute top-10 left-10 w-4 h-4 rounded-full bg-purple-200 animate-pulse"></div>
        <div class="absolute top-20 left-16 w-2 h-2 rounded-full bg-indigo-200"></div>
        <div class="absolute bottom-10 right-10 w-6 h-6 rounded-full bg-pink-100 opacity-60"></div>

        <!-- Left Column: Avatar & Main Info (Narrower: 30%) -->
        <div class="w-full md:w-[30%] flex flex-col z-10 shrink-0">
            <!-- Avatar -->
            <div class="relative w-full max-w-[240px] mx-auto mb-6">
                <div class="tape"></div>
                <div class="polaroid w-full relative group cursor-pointer overflow-hidden" style="aspect-ratio: 3/4;">
                    <div id="avatar-preview" class="w-full h-full bg-slate-50 flex items-center justify-center text-slate-300 overflow-hidden rounded-sm">
                        <span id="avatar-placeholder" class="text-5xl">ğŸ±</span>
                        <img id="avatar-img" src="" class="hidden w-full h-full object-cover">
                    </div>
                    <div class="absolute bottom-2 right-4 text-slate-400 text-xs handwriting">
                        <span id="card-date">2026.02.11</span>
                    </div>
                </div>
            </div>
            
            <!-- Name & Tags -->
            <div class="text-center mb-6">
                <h1 id="card-name" class="text-2xl font-bold text-slate-800 tracking-tight mb-6">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å</h1>
                <div id="card-tags" class="flex flex-wrap justify-center gap-2">
                    <span class="tag">#å¯æ„›ã„</span>
                    <span class="tag">#å„ªã—ã„</span>
                </div>
            </div>

            <!-- Description Section (Left) -->
            <div class="px-2 mb-4">
                <section class="w-full space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="h-5 w-1 bg-purple-400 rounded-full"></div>
                        <div>
                            <h2 class="text-sm font-bold text-slate-800">æ¨ã—ã‚’ä¸€è¨€ã§ç´¹ä»‹</h2>
                            <p class="text-[8px] text-slate-400 uppercase tracking-[0.2em] font-medium">Character Profile</p>
                        </div>
                    </div>
                    <div class="bg-slate-50/50 p-4 rounded-2xl border border-slate-100 backdrop-blur-sm">
                        <p id="card-desc" class="text-slate-600 leading-relaxed text-[13px]">
                            ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ€§æ ¼ã‚„é­…åŠ›ã€å‡ºä¼šã£ãŸãã£ã‹ã‘ãªã©ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                        </p>
                    </div>
                </section>
            </div>
        </div>

        <!-- Right Column: Messages (Wider: 70%) -->
        <div class="w-full md:w-[70%] flex flex-col z-10 md:border-l md:border-slate-100 md:pl-10">
            <!-- Messages Section -->
            <section class="flex flex-col flex-grow space-y-4 mb-6">
                <div class="flex items-center gap-3">
                    <div class="h-8 w-1 bg-indigo-400 rounded-full"></div>
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">ã‚ãªãŸã¸ã®æƒ³ã„</h2>
                        <p class="text-[10px] text-slate-400 uppercase tracking-[0.2em] font-medium">LOVE & GRATITUDE</p>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-2xl border border-slate-100 shadow-sm relative flex-grow min-h-[350px]">
                    <!-- Subtle pattern -->
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 5L22.5 15H32.5L24.5 21L27 31L20 25L13 31L15.5 21L7.5 15H17.5L20 5Z" fill="#6366f1"/>
                        </svg>
                    </div>
                    <p id="card-message" class="text-slate-700 leading-loose handwriting text-lg whitespace-pre-wrap">
å¤§å¥½ããªã‚ãªãŸã¸ï¼š

ï¼ˆã“ã“ã«æƒ³ã„ã‚’ç¶´ã£ã¦ãã ã•ã„...ï¼‰

ã€Œã©ã‚“ãªå°ã•ãªç¬é–“ã‚‚ã€ ã‚ãªãŸãŒã„ã‚‹ã ã‘ã§è¼ã„ã¦è¦‹ãˆã¾ã—ãŸã€‚ã€

...ã®ã‚ˆã†ãªã€ã‚ãªãŸã ã‘ã®ç‰¹åˆ¥ãªæƒ³ã„å‡ºã‚’è¨€è‘‰ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
                    </p>
                </div>
            </section>

            <!-- Footer -->
            <div class="flex justify-between items-end">
                <div class="space-y-1">
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Generated by</p>
                    <p class="text-sm font-bold text-purple-500 tracking-tighter italic">MooXã¯ã€ã‚ãªãŸã¨å…±ã«æƒ³ã†</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-slate-300">#FOREVER_MEMORIES</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Controls -->
    <div class="w-full max-w-5xl bg-white p-10 rounded-3xl shadow-xl border border-slate-100">
        <div class="flex items-center gap-3 mb-8">
            <div class="p-2 bg-purple-100 rounded-lg">
                <span class="text-xl">âœ¨</span>
            </div>
            <h3 class="text-2xl font-bold text-slate-800">å‘Šç™½ã‚«ãƒ¼ãƒ‰ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-700 ml-1">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å</label>
                    <input type="text" id="input-name" placeholder="ä¾‹ï¼šæ¥½èŒ‰ Rakuma" class="w-full px-5 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-purple-400 outline-none transition-all text-slate-600">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-700 ml-1">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                    <input type="text" id="input-tags" placeholder="å¯æ„›ã„, å„ªã—ã„, æ¢åµ" class="w-full px-5 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-purple-400 outline-none transition-all text-slate-600">
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-700 ml-1">ç”»åƒã‚’é¸æŠ</label>
                    <input type="file" id="input-avatar" accept="image/*" class="w-full px-5 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-purple-400 outline-none transition-all text-slate-600 text-xs file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-100 file:text-purple-700 hover:file:bg-purple-200">
                </div>
            </div>
            
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-700 ml-1">æ¨ã—ã‚’ä¸€è¨€ã§ç´¹ä»‹</label>
                    <textarea id="input-desc" maxlength="50" placeholder="æ€§æ ¼ã‚„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãªã©ã‚’è‡ªç”±ã«è¨˜å…¥ã—ã¦ãã ã•ã„..." rows="6" class="w-full px-5 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-purple-400 outline-none transition-all text-slate-600 resize-none"></textarea>
                    <p class="text-xs text-slate-400 text-right mr-1">â€»50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                </div>
                <div class="space-y-2">
                    <label class="text-sm font-bold text-slate-700 ml-1">ã‚ãªãŸã¸ã®æƒ³ã„</label>
                    <textarea id="input-message" maxlength="300" placeholder="ä¼ãˆãŸã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„..." rows="6" class="w-full px-5 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-purple-400 outline-none transition-all text-slate-600 resize-none"></textarea>
                    <p class="text-xs text-slate-400 text-right mr-1">â€»300æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                </div>
            </div>
        </div>

        <div class="mt-10 pt-8 border-t border-slate-50 flex flex-col md:flex-row items-center justify-between gap-4">
            <p class="text-slate-400 text-sm italic">
                ğŸ’¡ è¨˜å…¥ãŒçµ‚ã‚ã£ãŸã‚‰ã€å³å´ã®ãƒœã‚¿ãƒ³ã§ç”»åƒã‚’ç”Ÿæˆãƒ»ä¿å­˜ã—ã¾ã—ã‚‡ã†ï¼
            </p>
            <div class="flex gap-4">
                <button onclick="downloadAsImage()" id="download-btn" class="px-8 py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2">
                    <span id="btn-text">ç”»åƒã¨ã—ã¦ä¿å­˜</span>
                    <div id="btn-loader" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal for Mobile Save -->
    <div id="save-modal" class="fixed inset-0 z-50 bg-black/80 hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-4 max-w-lg w-full max-h-[90vh] flex flex-col relative animate-fade-in">
            <button onclick="closeModal()" class="absolute -top-12 right-0 text-white p-2 hover:bg-white/20 rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <div class="text-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">âœ¨ ç”»åƒãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼</h3>
                <p class="text-sm text-slate-500 mt-1">
                    <span class="md:hidden">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„</span>
                    <span class="hidden md:inline">è‡ªå‹•çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå§‹ã¾ã‚Šã¾ã™</span>
                </p>
            </div>
            
            <div class="flex-1 overflow-auto bg-slate-100 rounded-xl flex items-center justify-center p-2">
                <img id="generated-image" src="" alt="Generated Card" class="max-w-full max-h-full object-contain shadow-lg">
            </div>

            <button onclick="closeModal()" class="mt-4 w-full py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition-colors">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <script>
        const inputs = {
            name: document.getElementById('input-name'),
            tags: document.getElementById('input-tags'),
            desc: document.getElementById('input-desc'),
            avatar: document.getElementById('input-avatar'),
            message: document.getElementById('input-message')
        };

        const displays = {
            name: document.getElementById('card-name'),
            tags: document.getElementById('card-tags'),
            desc: document.getElementById('card-desc'),
            avatarImg: document.getElementById('avatar-img'),
            avatarPlaceholder: document.getElementById('avatar-placeholder'),
            message: document.getElementById('card-message')
        };

        inputs.name.addEventListener('input', (e) => {
            displays.name.textContent = e.target.value || 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å';
        });

        inputs.tags.addEventListener('input', (e) => {
            const tags = e.target.value.split(/[,ï¼Œã€]/).filter(t => t.trim());
            displays.tags.innerHTML = tags.length > 0 
                ? tags.map(t => `<span class="tag">#${t.trim()}</span>`).join('')
                : '<span class="tag">#å¯æ„›ã„</span><span class="tag">#å„ªã—ã„</span><span class="tag">#ç§ã®ãƒ’ãƒ¼ãƒ­ãƒ¼</span>';
        });

        inputs.desc.addEventListener('input', (e) => {
            displays.desc.textContent = e.target.value || 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ€§æ ¼ã‚„é­…åŠ›ã€å‡ºä¼šã£ãŸãã£ã‹ã‘ãªã©ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        });

        inputs.message.addEventListener('input', (e) => {
            displays.message.textContent = e.target.value || 'å¤§å¥½ããªã‚ãªãŸã¸ï¼š\n\nï¼ˆã“ã“ã«æƒ³ã„ã‚’ç¶´ã£ã¦ãã ã•ã„...ï¼‰\n\nã€Œã©ã‚“ãªå°ã•ãªç¬é–“ã‚‚ã€ ã‚ãªãŸãŒã„ã‚‹ã ã‘ã§è¼ã„ã¦è§ãˆã¾ã—ãŸã€‚ã€\n\n...ã®ã‚ˆã†ãªã€ã‚ãªãŸã ã‘ã®ç‰¹åˆ¥ãªæƒ³ã„å‡ºã‚’è¨€è‘‰ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
        });

        inputs.avatar.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    displays.avatarImg.src = event.target.result;
                    displays.avatarImg.classList.remove('hidden');
                    displays.avatarPlaceholder.classList.add('hidden');
                };
                reader.onerror = () => {
                    displays.avatarImg.classList.add('hidden');
                    displays.avatarPlaceholder.classList.remove('hidden');
                    displays.avatarPlaceholder.textContent = 'âŒ';
                };
                reader.readAsDataURL(file);
            } else {
                displays.avatarImg.classList.add('hidden');
                displays.avatarPlaceholder.classList.remove('hidden');
                displays.avatarPlaceholder.textContent = 'ğŸ±';
            }
        });

        // Set current date
        const now = new Date();
        document.getElementById('card-date').textContent = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;

        function closeModal() {
            document.getElementById('save-modal').classList.add('hidden');
        }

        async function downloadAsImage() {
            const card = document.getElementById('confession-card');
            const btn = document.getElementById('download-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            const characterName = document.getElementById('input-name').value || 'character';
            const modal = document.getElementById('save-modal');
            const generatedImage = document.getElementById('generated-image');

            // UI Feedback
            btn.disabled = true;
            btnText.textContent = 'ç”Ÿæˆä¸­...';
            btnLoader.classList.remove('hidden');

            try {
                // Wait for any images to load (just in case)
                await new Promise(resolve => setTimeout(resolve, 500));

                const canvas = await html2canvas(card, {
                    scale: 3, 
                    useCORS: true,
                    backgroundColor: null, 
                    logging: false,
                    width: 1280,       
                    onclone: (clonedDoc) => {
                        const clonedCard = clonedDoc.getElementById('confession-card');
                        
                        // 1. Force Exact Desktop Dimensions
                        clonedCard.style.width = "1280px";
                        clonedCard.style.maxWidth = "none";
                        clonedCard.style.height = "auto";
                        clonedCard.style.minHeight = "800px";
                        clonedCard.style.transform = "none";
                        
                        // Fix Background Rendering
                        clonedCard.style.backgroundColor = "#ffffff"; 
                        // Updated to Sakura Pink gradients
                        clonedCard.style.backgroundImage = `
                            radial-gradient(at 0% 0%, rgba(254, 226, 226, 0.5) 0, rgba(255, 255, 255, 0) 50%), 
                            radial-gradient(at 100% 0%, rgba(255, 209, 220, 0.5) 0, rgba(255, 255, 255, 0) 50%),
                            radial-gradient(at 100% 100%, rgba(253, 224, 245, 0.5) 0, rgba(255, 255, 255, 0) 50%),
                            radial-gradient(at 0% 100%, rgba(255, 241, 242, 0.5) 0, rgba(255, 255, 255, 0) 50%)
                        `;  
                        
                        // Simulate backdrop-filter (html2canvas doesn't support blur)
                        // Make semi-transparent elements more opaque so they are visible in export
                        const tape = clonedCard.querySelector('.tape');
                        if (tape) {
                            tape.style.backgroundColor = "rgba(244, 114, 182, 0.4)"; // Pinkish tape (pink-400 with opacity)
                        }
                        
                        // Find description box (bg-slate-50/50) and make it solid
                        const descBox = clonedCard.querySelector('.bg-slate-50\\/50');
                        if (descBox) {
                            descBox.style.backgroundColor = "rgba(248, 250, 252, 0.95)"; // Almost solid white
                            descBox.style.border = "1px solid #e2e8f0"; // Reinforce border
                        } 
                        
                        // 2. Force Flex Layout (No wrapping)
                        clonedCard.style.display = "flex";
                        clonedCard.style.flexDirection = "row";
                        clonedCard.style.alignItems = "stretch";
                        clonedCard.style.padding = "40px";
                        clonedCard.style.gap = "40px";
                        
                        // 3. STRICT Column Sizing
                        const leftCol = clonedCard.querySelector('.md\\:w-\\[30\\%\\]');
                        const rightCol = clonedCard.querySelector('.md\\:w-\\[70\\%\\]');
                        
                        if (leftCol) {
                            leftCol.style.width = "350px"; 
                            leftCol.style.minWidth = "350px"; 
                            leftCol.style.maxWidth = "350px"; 
                            leftCol.style.flex = "0 0 350px";
                            
                             const polaroid = leftCol.querySelector('.polaroid');
                             if (polaroid) {
                                 polaroid.style.width = "270px"; 
                                 polaroid.style.height = "360px"; 
                                 polaroid.style.minHeight = "360px";
                                 polaroid.style.margin = "0 auto";
                                 polaroid.style.aspectRatio = "auto"; 
                                 polaroid.style.display = "block"; 
                                 polaroid.style.overflow = "hidden"; 
                                 polaroid.style.transform = "rotate(-1.5deg)";
                                 
                                 const imgContainer = polaroid.querySelector('#avatar-preview');
                                 if (imgContainer) {
                                     imgContainer.style.width = "100%";
                                     imgContainer.style.height = "100%";
                                     imgContainer.style.display = "flex";
                                     imgContainer.style.overflow = "hidden";
                                     
                                     const img = imgContainer.querySelector('img');
                                     if (img && img.src) {
                                        const imgSrc = img.src;
                                        img.style.display = "none";
                                        
                                        imgContainer.style.backgroundImage = `url("${imgSrc}")`;
                                        imgContainer.style.backgroundSize = "cover";
                                        imgContainer.style.backgroundPosition = "center center";
                                        imgContainer.style.backgroundRepeat = "no-repeat";
                                     }
                                 }
                             }
                        }
                        
                        // Increase spacing between Polaroid and Name Section
                        const nameSection = leftCol.querySelector('.text-center');
                        if (nameSection) {
                            nameSection.style.marginTop = "32px"; 
                            nameSection.style.marginBottom = "32px";
                            
                            // Increase spacing between Name and Tags
                            const nameTitle = nameSection.querySelector('h1');
                            if (nameTitle) {
                                nameTitle.style.marginBottom = "24px";
                            }
                            
                            // Fix Tag Text Vertical Alignment (Hack for html2canvas)
                            const tags = nameSection.querySelectorAll('.tag');
                            tags.forEach(tag => {
                                // Force flex centering
                                tag.style.display = "inline-flex";
                                tag.style.alignItems = "center";
                                tag.style.justifyContent = "center";
                                // Remove fixed height if set in CSS, let padding handle it with bias
                                tag.style.height = "auto";
                                // Shift text UP by reducing top padding and increasing bottom padding
                                tag.style.paddingTop = "2px";
                                tag.style.paddingBottom = "6px";
                            });
                        }
                        
                        if (rightCol) {
                             rightCol.style.width = "810px";
                             rightCol.style.minWidth = "810px";
                             rightCol.style.flex = "1";
                             rightCol.style.borderLeftWidth = "1px";
                             rightCol.style.paddingLeft = "40px";
                        }
                    }
                });

                const dataUrl = canvas.toDataURL("image/png");
                
                // Show Modal for everyone (Safe fallback for mobile)
                generatedImage.src = dataUrl;
                modal.classList.remove('hidden');

                // Try automatic download for desktop
                if (!/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    const link = document.createElement('a');
                    link.download = `confession-${characterName}.png`;
                    link.href = dataUrl;
                    link.click();
                }

            } catch (err) {
                console.error(err);
                alert('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } finally {
                btn.disabled = false;
                btnText.textContent = 'ç”»åƒã¨ã—ã¦ä¿å­˜';
                btnLoader.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
